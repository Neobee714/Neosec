"""
漏洞数据模型 (Vulnerability Data Model)

定义安全漏洞的标准化数据结构，兼容 CVE、CVSS 等行业标准。
"""

from typing import Optional
from datetime import datetime
from enum import Enum
from pydantic import BaseModel, Field, field_validator


class SeverityLevel(str, Enum):
    """漏洞严重程度枚举 (Severity Level Enumeration)"""
    CRITICAL = "critical"  # 严重
    HIGH = "high"  # 高危
    MEDIUM = "medium"  # 中危
    LOW = "low"  # 低危
    INFO = "info"  # 信息


class VulnerabilityCategory(str, Enum):
    """漏洞分类枚举 (Vulnerability Category Enumeration)"""
    SQL_INJECTION = "sql_injection"  # SQL 注入
    XSS = "xss"  # 跨站脚本攻击
    CSRF = "csrf"  # 跨站请求伪造
    RCE = "rce"  # 远程代码执行
    LFI = "lfi"  # 本地文件包含
    RFI = "rfi"  # 远程文件包含
    SSRF = "ssrf"  # 服务端请求伪造
    XXE = "xxe"  # XML 外部实体注入
    IDOR = "idor"  # 不安全的直接对象引用
    AUTH_BYPASS = "auth_bypass"  # 认证绕过
    PRIVILEGE_ESCALATION = "privilege_escalation"  # 权限提升
    INFO_DISCLOSURE = "info_disclosure"  # 信息泄露
    MISCONFIGURATION = "misconfiguration"  # 配置错误
    OUTDATED_SOFTWARE = "outdated_software"  # 过时软件
    WEAK_CREDENTIALS = "weak_credentials"  # 弱凭证
    OTHER = "other"  # 其他


class CVSSScore(BaseModel):
    """
    CVSS 评分模型 (CVSS Score Model)

    Common Vulnerability Scoring System (通用漏洞评分系统) 数据结构。
    """
    version: str = Field("3.1", description="CVSS 版本（2.0/3.0/3.1）")
    base_score: float = Field(..., description="基础评分（0.0-10.0）", ge=0.0, le=10.0)
    temporal_score: Optional[float] = Field(None, description="时间评分", ge=0.0, le=10.0)
    environmental_score: Optional[float] = Field(None, description="环境评分", ge=0.0, le=10.0)
    vector_string: Optional[str] = Field(None, description="CVSS 向量字符串")

    @field_validator('version')
    @classmethod
    def validate_version(cls, v: str) -> str:
        """验证 CVSS 版本"""
        valid_versions = ["2.0", "3.0", "3.1", "4.0"]
        if v not in valid_versions:
            raise ValueError(f"无效的 CVSS 版本: {v}")
        return v


class Reference(BaseModel):
    """
    漏洞参考链接模型 (Vulnerability Reference Model)

    外部参考资源（CVE、CWE、文章等）。
    """
    type: str = Field(..., description="参考类型（cve/cwe/advisory/article）")
    url: str = Field(..., description="参考链接 URL")
    title: Optional[str] = Field(None, description="参考标题")


class Vulnerability(BaseModel):
    """
    漏洞模型 (Vulnerability Model)

    标准化的漏洞数据结构，用于统一表示所有工具发现的安全问题。
    """
    vuln_id: str = Field(..., description="漏洞唯一标识符")
    title: str = Field(..., description="漏洞标题")
    description: str = Field(..., description="漏洞详细描述")

    # 严重程度
    severity: SeverityLevel = Field(..., description="严重程度")
    category: VulnerabilityCategory = Field(..., description="漏洞分类")
    cvss: Optional[CVSSScore] = Field(None, description="CVSS 评分")

    # 目标信息
    target: str = Field(..., description="受影响的目标（IP/域名/URL）")
    affected_component: Optional[str] = Field(None, description="受影响的组件（如软件名称）")
    affected_version: Optional[str] = Field(None, description="受影响的版本")
    endpoint: Optional[str] = Field(None, description="具体的漏洞端点（如 URL 路径）")

    # CVE/CWE 标识
    cve_id: Optional[str] = Field(None, description="CVE 编号")
    cwe_id: Optional[str] = Field(None, description="CWE 编号")

    # 验证信息
    verified: bool = Field(False, description="是否已验证")
    false_positive: bool = Field(False, description="是否为误报")
    exploitable: bool = Field(False, description="是否可利用")

    # PoC 和修复建议
    proof_of_concept: Optional[str] = Field(None, description="概念验证代码或步骤")
    remediation: Optional[str] = Field(None, description="修复建议")
    references: list[Reference] = Field(default_factory=list, description="参考链接列表")

    # 发现信息
    source_tool: str = Field(..., description="发现该漏洞的工具名称")
    template_id: Optional[str] = Field(None, description="使用的模板ID（如 Nuclei 模板）")
    matcher_name: Optional[str] = Field(None, description="匹配器名称")

    # 请求/响应数据（用于复现）
    http_request: Optional[str] = Field(None, description="HTTP 请求数据")
    http_response: Optional[str] = Field(None, description="HTTP 响应数据")
    extracted_data: dict[str, any] = Field(default_factory=dict, description="提取的关键数据")

    # 元数据
    metadata: dict[str, any] = Field(default_factory=dict, description="额外元数据")
    discovered_at: datetime = Field(default_factory=datetime.now, description="发现时间")
    last_verified: Optional[datetime] = Field(None, description="最后验证时间")

    @field_validator('cve_id')
    @classmethod
    def validate_cve_format(cls, v: Optional[str]) -> Optional[str]:
        """验证 CVE 编号格式（简单验证）"""
        if v is None:
            return v
        if not v.startswith("CVE-"):
            raise ValueError(f"无效的 CVE 格式: {v}，应以 'CVE-' 开头")
        return v

    @field_validator('cwe_id')
    @classmethod
    def validate_cwe_format(cls, v: Optional[str]) -> Optional[str]:
        """验证 CWE 编号格式（简单验证）"""
        if v is None:
            return v
        if not v.startswith("CWE-"):
            raise ValueError(f"无效的 CWE 格式: {v}，应以 'CWE-' 开头")
        return v

    def mark_as_verified(self) -> None:
        """标记漏洞为已验证"""
        self.verified = True
        self.last_verified = datetime.now()

    def mark_as_false_positive(self) -> None:
        """标记漏洞为误报"""
        self.false_positive = True
        self.verified = True
        self.last_verified = datetime.now()


class ScanResult(BaseModel):
    """
    扫描结果汇总模型 (Scan Result Summary Model)

    包含完整扫描会话的所有资产和漏洞数据。
    """
    scan_id: str = Field(..., description="扫描会话唯一标识符")
    target: str = Field(..., description="扫描目标")
    workflow_name: str = Field(..., description="使用的工作流名称")

    # 资产和漏洞列表
    assets: list = Field(default_factory=list, description="发现的资产列表")  # List[Asset]
    vulnerabilities: list = Field(default_factory=list, description="发现的漏洞列表")  # List[Vulnerability]

    # 统计信息
    total_assets: int = Field(0, description="资产总数")
    total_vulnerabilities: int = Field(0, description="漏洞总数")
    critical_count: int = Field(0, description="严重漏洞数量")
    high_count: int = Field(0, description="高危漏洞数量")
    medium_count: int = Field(0, description="中危漏洞数量")
    low_count: int = Field(0, description="低危漏洞数量")
    info_count: int = Field(0, description="信息级别数量")

    # 时间信息
    started_at: datetime = Field(default_factory=datetime.now, description="扫描开始时间")
    completed_at: Optional[datetime] = Field(None, description="扫描完成时间")
    duration_seconds: Optional[int] = Field(None, description="扫描耗时（秒）")

    # 元数据
    metadata: dict[str, any] = Field(default_factory=dict, description="额外元数据")

    def calculate_statistics(self) -> None:
        """计算统计信息"""
        self.total_assets = len(self.assets)
        self.total_vulnerabilities = len(self.vulnerabilities)

        # 统计各严重程度的漏洞数量
        self.critical_count = sum(1 for v in self.vulnerabilities if v.severity == SeverityLevel.CRITICAL)
        self.high_count = sum(1 for v in self.vulnerabilities if v.severity == SeverityLevel.HIGH)
        self.medium_count = sum(1 for v in self.vulnerabilities if v.severity == SeverityLevel.MEDIUM)
        self.low_count = sum(1 for v in self.vulnerabilities if v.severity == SeverityLevel.LOW)
        self.info_count = sum(1 for v in self.vulnerabilities if v.severity == SeverityLevel.INFO)

    def mark_completed(self) -> None:
        """标记扫描完成并计算耗时"""
        self.completed_at = datetime.now()
        if self.started_at:
            self.duration_seconds = int((self.completed_at - self.started_at).total_seconds())
        self.calculate_statistics()
